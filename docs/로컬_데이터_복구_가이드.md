# 로컬 데이터 복구 가이드

Supabase로 전환한 뒤, 예전에 로컬에 있던 자료를 복구하는 방법입니다.

---

## 1. 먼저 확인할 것 (백업이 있는지)

로컬 자료는 다음 위치에 있었습니다.

| 자료 종류 | 예전 위치 | 설명 |
|-----------|-----------|------|
| **전체 DB** | `data/app.db` | SQLite 파일 (통계 목록, 가상인구 DB, 템플릿 등) |
| **2차 대입 결과** | `data/step2_records/*.xlsx` + `*.json` | Excel 파일과 메타 정보 |

다음을 순서대로 확인해 보세요.

1. **휴지통(Recycle Bin)**  
   `data` 폴더나 `app.db`를 지웠다면 휴지통에 있을 수 있습니다.

2. **Windows 이전 버전**  
   `data` 폴더 우클릭 → **속성** → **이전 버전** 탭에서 복원할 수 있는 버전이 있는지 확인.

3. **백업/클라우드**  
   OneDrive, Google 드라이브, 타임라인 백업 등에 `virtual_population_generator` 또는 `data` 폴더가 백업돼 있는지 확인.

4. **다른 PC**  
   같은 프로젝트를 다른 컴퓨터에서 실행한 적이 있다면, 그쪽의 `data` 폴더가 백업 역할을 할 수 있습니다.

---

## 2. 백업이 있을 때: Supabase로 옮기기

### 2-1. `data/app.db` 백업이 있는 경우

1. 백업한 `app.db` 파일을 프로젝트의 **`data/`** 폴더에 넣습니다.  
   (없다면 `data` 폴더를 만든 뒤 넣어도 됩니다.)

2. 터미널에서 프로젝트 루트로 이동한 뒤, 마이그레이션 스크립트를 실행합니다.

   ```powershell
   cd c:\Users\user\Desktop\virtual_population_generator
   .\venv\Scripts\Activate.ps1
   python scripts/migrate_local_to_supabase.py
   ```

   `app.db`가 다른 경로에 있다면:

   ```powershell
   python scripts/migrate_local_to_supabase.py --sqlite "D:\backup\app.db"
   ```

3. `.streamlit/secrets.toml` 또는 `.env`에 **SUPABASE_URL**, **SUPABASE_KEY**가 설정돼 있어야 합니다.  
   (앱 실행 시 사용하는 것과 동일한 값이면 됩니다.)

이렇게 하면 **통계 목록(stats)**, **축별 마진 통계**, **시도별 템플릿**, **가상인구 DB**가 Supabase로 복사됩니다.

### 2-2. `data/step2_records` 백업만 있는 경우 (app.db 없음)

2차 대입 결과 Excel만 남아 있는 경우입니다.

1. 백업한 **`step2_records`** 폴더 전체를 프로젝트의 **`data/`** 안에 복원합니다.  
   최종 경로 예: `data/step2_records/2024-01-15_14-30-00_37.xlsx` + `2024-01-15_14-30-00_37.json`

2. 같은 방식으로 마이그레이션 스크립트를 실행합니다.

   ```powershell
   python scripts/migrate_local_to_supabase.py
   ```

   스크립트는 `data/step2_records/`를 자동으로 찾아, **가상인구 DB** 테이블에만 넣습니다.  
   (각 기록은 `.xlsx`와 같은 이름의 `.json` 메타 파일이 있어야 인식됩니다.)

3. 2차 대입 결과만 있고 `.json`이 없다면, 같은 이름으로 최소한의 `.json`을 만들어 주어야 합니다.  
   예: `2024-01-15_14-30-00_37.json` 내용 예시:

   ```json
   {
     "timestamp": "2024-01-15 14:30:00",
     "sido_code": "37",
     "sido_name": "경상북도",
     "rows": 100,
     "added_columns": [],
     "columns_count": 20
   }
   ```

   (`rows`, `added_columns`, `columns_count`는 대략적인 값이라도 넣으면 됩니다.)

---

## 3. 백업이 전혀 없을 때

- **Windows 파일 히스토리**를 켜 두었다면: 해당 드라이브의 이전 버전에서 `data` 폴더를 복원할 수 있는지 확인해 보세요.
- 그 외에는 로컬에서 **다시 생성**하는 수밖에 없습니다.  
  - **가상인구 생성** 페이지에서 1단계 → 2단계 대입 후, **가상인구 DB** 페이지에서 “선택한 기록을 DB에 추가”로 Supabase에 쌓을 수 있습니다.
  - **통계 목록**은 가상인구 생성 탭의 “데이터 관리”에서 다시 등록해야 합니다.

---

## 4. 마이그레이션 스크립트 옵션 요약

```text
python scripts/migrate_local_to_supabase.py [옵션]

  --sqlite 경로   SQLite DB 파일 (기본: data/app.db)
  --step2 경로    2차 대입 결과 폴더 (기본: data/step2_records)
  --dry-run       실제 전송 없이 경로·대상만 확인
```

- `--dry-run`으로 한 번 실행해 보면, 어떤 경로를 찾는지·어떤 데이터가 있는지 확인할 수 있습니다.

이 가이드와 `scripts/migrate_local_to_supabase.py`를 사용하면, 백업이 있는 한 로컬 자료를 Supabase로 최대한 복구할 수 있습니다.
